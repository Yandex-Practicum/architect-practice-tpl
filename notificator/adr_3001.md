#### ID: ADR-3001

#### Дата: 2023.10.08

#### Статус: Предложено

#### Участники:
* Абдрахманов Марат

#### Решения:
* В качестве брокера выбрана Kafka со следующими топиками:
    * new_notify - топик в который пишет API Gateway, когда принимает задание на отправку нового сообщения или параметры каналов связи. Из этого топика читает Notify Service.
    * send_notify - топик в который пишет Notify Service, когда принимает решение об отправке сообщения. Из этого топика читает Multiplexer & Sender Service..
* API Gateway и Notify Service является отдельными микросервисами.
* API Gateway должен включать в себя следующие компоненты:
    * REST Controller - контроллер с REST-ручками нашей системы.
    * Validator - компонент, который содержит процедуры валидации запросов.
    * Kafka Producer - компонент, который осуществляет запись в Kafka (в топик new_notify).
* Notify Service состоит из 2-х подсистем:
    * New notify service processor обрабатывает данные от API Gateway, содержит компоненты:
        * Kafka Consumer - считывает данные из Kafka (топик new_notify)
        * New notify processor - обрабатывает полученное сообщение и:
            * если это данные о канале связи, то сохраняет их в БД через соответствующий репозиторий;
            * если это команда на регламентное уведомление, то сохраняет об этом информацию в БД и отправляет задание в подсистему Notify sender service;
            * если это команда на однократное уведомление, то отправляет об этом информацию в БД и отправляет задание в подсистему Notify sender service.
        * Repository - репозиторий, через который осуществляется запись в хранилище "Параметры отправителей и  регламентных рассылок".
    * Notify sender service - планирует отправку сообщений, содержит компоненты:
        * Notify Scheduler - планировщик отправки сообщений. Информацию об однократной отправке получает от "New notify processor". Информацию о регламентной отправки сообщений также получает от "New notify processor" и из хранилища "Параметры отправителей и  регламентных рассылок" при запуске Notify Service. Когда отправляется новое уведомление, информация об этом фиксируется в "БД хранения рассылок".
        * Kafka Producer - отправляет данные в Kafka (топик send_notify).
        * Repository - репозиторий, через который осуществляется запись в хранилище "Параметры отправителей и  регламентных рассылок" и "БД хранения рассылок".
* Хранилище "Параметры отправителей и  регламентных рассылок" может быть построена на базе PostgreSQL.
* Хранилище "БД хранения рассылок" может быть построена на базе PostgreSQL.

#### Контекст:
Необходимо спроектировать внутреннее устройство контейнеров API Gateway, Notify Service и брокера. Принято решение придерживаться микросервисной архитектуры. Необходимо учесть Архитектурные решения и Принципы проектирования из ADR-001.

#### Последствия:

#### Положительные:
* Брокер Kafka довольно популярный в индустрии. Зарекомендовал себя как надежное и быстрое решение для построения асинхронного взаимодействия между сервисами. 
* БД PostgreSQL также является проверенным решением, обладает хорошей производительностью и надежностью. Позволяет строить шардированные хранилища данных, что может в будущем понадобиться для "БД хранения рассылок".
* Как правило Kafka и PostgreSQL не являются какими-то экзотическими решениями для специалистов в области современной backend разработки, благодаря большому количество информации по этим продуктам, разобраться с ними будет не сложно. Также, что немаловажно, это открытые, бесплатные программные продукты.
* Использование шаблона проектирования "Репозиторий", является одним из стандартных решений для доступа к хранилища данных. При необходимость можно заменить хранилище и реализацию репозитория не трогая его интерфейс.

#### Отрицательные:
* Для работы с Kafka необходимо поднимать Zookeeper и сам брокер (хотя вроде теперь можно и без Zookeeper). Также, по хорошему, Kafka можно запустить с фактором репликации 2, что в итоге потребует 3 docker-контейнера.
* Есть проблема с запуском ещё одного экземпляра Notify Service, в случае, если потребуется большая производительность. Т.к. им придется как-то между собой договариваться, кто какие регламентные уведомления будет рассылать. При одиночных уведомлениях должно быть все ОК.