#### ID: ADR-001

#### Дата: 2023.10.07

#### Статус: Предложено

#### Участники:
* Абдрахманов Марат

#### Решения:
В результате анализа требований к системе, ее процессов и данных были приняты следующие решения:
* Структура: Архитектурный стиль - архитектура микросервисов.
* Свойства системы: доступность, надежность, тестируемость, масштабируемость, безопасность, гибкость, отказоустойчивость, развертываемость, наблюдаемость.
* Архитектурные решения (некоторые):
    * Доступ к нашему сервису для внешних систем производится через Proxy.
        * Обоснование: данный Proxy реализует слой защиты от повреждений (обеспечивает работу с повторами, отвечает за обработку ошибок (сеть - отстутствие связи, задержки и т.п.)).
    * Работа нашего сервиса с системами отправки уведомлений выполняется через специальные шлюзы.
        * Обоснование: на уровне данных шлюзов реализуется работа с потенциальными ограничениями внешних систем и пропускной способностью (ограничение количества символов в СМС, стоимость СМС, лимиты пуш-очередей провайдеров, возможность попадания e-mail в спам и т.д.). Также в дальнейшем может потребоваться расширение списка сервисов, в которые можно будет отправлять сообщения (например, Telegram), в этом случае достаточно будет разработать ещё один шлюз и включить его в систему.
    * Шлюзы для работы с внешними сервисами соединяются с ними через выходной Proxy.
        * Обоснование: на уровне этого Proxy решаются задачи по обеспечению безопасности и работы с сетью общие для всех выходных соединений. Такое решение позволит повысить безопасность в случае, если например в реализации какого-то шлюза есть уязвимость из-за ошибок в реализации.
    * Доступ к БД должны иметь только связанные с ними сервисы. БД не должны быть доступны внешним пользователям.
        * Обсонование: согласно правилам построения микросервисной архитектуры, каждый микросервис работает только со своей БД. Также такое решение позволит уменьшить зацепление между компонентами системы.
    * Работу с сервисами уведомлений может осуществлять только сервис мультиплексирования и отправки уведомлений, другие доступа к ним не должны иметь.
        * Обоснование: решение принято на основе разделения обязанностей (принцип единой ответственности).
* Принципы проектирования (некоторые):
    * Для повышения производительности процесса отправки уведомлений взаимодействие между шлюзом, принимающим задания от внешних систем, сервисом уведомлений и сервисом мультиплексирования и отправки уведомлений должно осуществляться асинхронно.
    * Для взаимодействия с внешними сервисами по возможности использовать REST API.
        * Обоснование: это наиболее известная технология в работе с которой есть опыт у большого количества разработчиков. Также, как правило, есть хорошая поддержка на уровне разных платформ/языков программирования.
    * Для синхронного взаимодействия сервисов внутри системы по возможности использовать gRPC.
        * Обоснование: gRPC зарекомендовало себя как быстрое и надежное решение для реализации межсетевого взаимодействия, потенциально более эффективное по памяти в сравнении, например, с REST. Дополнительно этот аспект следуюет обсудить с командой разработки: есть ли компетенции в работе с этой технологии.        
    * Вести трассировку внешних взаимодействий.
        * Обоснование: подробная трассировка позволит быстрее локализовывать места, из-за которых возникают проблемы связи с сервисами, и выяснять их причины.
    * Использовать метрики для анализа производительности системы и т.п.
        * Обоснование: метрики позволят в режиме реального времени оценивать время ответа сервисов, кол-во запросов в единицу времени, потребление памяти и CPU и т.д. Это позволит оперативно реагировать на нештатные ситуации.
    * Использовать централизованное хранилище логов с возможностью их анализа.
        * Обоснование: такое хранение логов вместе с удобным инструментом для работы с ними позволит более быстро решать проблемы.
    * Параметры настройки каналов, данные пользователей и параметры рассылки хранить отдельно от информации об отправленных уведомлениях.
        * Обоснование: в будущем может потребоваться использование разных типов хранилищ для эти данных. Также это повысит общую безопасность системы.

#### Контекст:
В данном случае мы имеем общий контекст задачи, описываемый заданием из файла README.md и определенными в результате анализа процессами и данными.

Анализ систем рассылки SMS, Push-уведомлений и EMail'ов показал, что многие из них поддерживают REST API, примеры:
- https://www.epochta.ru/products/sms/sms-api
- https://iqsms.ru/
- https://onesignal.com/

При подготовке данного ADR использовались информация из курса и книга "Фундаментальный подход к программной архитектуры" Марка Ричардса и Нила Форда.

#### Последствия:

#### Положительные:
* Все связи нашей системы в внешним миром осуществляются через Proxy или спец. шлюзы, которые частично решают задачи прокси, что повышает безопасность системы.
* Использование спец. шлюзов для работы с внешними сервисами повысит общую надежность решения т.к. это отдельные подсистемы и ошибки в один не будут влиять (в теории) на другие. В рамках каждого шлюза можно учесть особенности взаимодействия с конкретными внешними сервисами. Также это повысит расширяемость системы, можно будет добавлять новыше шлюзы для связи с новыми типами сервисов уведомлений. Также это позволит поэтапно вводить в эксплуатацию решение: например, вначале реализовать EMail уведомление, потом SMS, потом Push, если ресурсов команды будет недостаточно.
* Наличие Proxy на выходе повысит безопасность системы и уменьшит количество точек стыковки с "внешним миром".
* Непрерывный рост объема данных об отправленных уведомлениях может потребовать реализации шардирования, поэтому при отделение этого хранилища данную задачу будет решить проще. 
* Хранение настроек каналов уведомлений и данных пользователя от другой информации повысит безопасность системы.
* Разделение на компоненты по выполняемым задачам позволит повысить тестируемость, гибкость и общую надежность системы.
* Использование асинхронного взаимодействия между ключевыми подсистемами позволит повысить общую производительность.
* Использование трассировки, сбора метрик и логов повысит общую наблюдаемость (observability) системы.

#### Отрицательные:
* Наличе Proxy на входе в систему создаст дополнительные сетевые задержки, также это потребует ресурсы (люди, время) на его конфигурирование и обслуживание.
* Использование отдельных шлюзов для работы с разными типами внешних систем повысит общее время разработки всего решения. Повысятся затраты на сопровождение системы в части развертывания и конфигурирования.
* Наличие выходного Proxy увеличит общее время сетевого обмена. При его отказе не будут работать все типы оповещения.
* Разделение на микросервисы потребует дополнительных затрат на учет особенностей межсетевого взаимодействия (задержки, отсутствие связи, изменение топологии, неоднородность сети и т.п.).
* Создание отдельных хранилищ для персональных данных и настроек и данных об отправленных уведомлениях увеличит затраны на сопровожение.
* Необходимо наличие инфраструктуры для развертывания такого решения.