# Технический проект "Сервис отправки оповещений"

## Текущая архитектура

В текущей архитектуре у нас есть мобильное приложение, которое общается с компонентом "Controller", а он в свою очередь делает запросы к "Foo" и "Bar".

![alt text](static/current_arch.svg)


## Целевая архитектура
Вводные данные по задаче сводятся к следующим пунктам:
* Нефункциональных требований к системе в явном виде не предъявлено
* Ограничения по бюджету и срокам не обозначены
* Возможности задать уточняющие вопросы заказчику нет
* Текущая архитектура больше походит на прототип, чем на высоконагруженную систему
* Информации о том, на какой инфраструктуре развернута или будет развернута текущая архитектура нет
* Информации о стеке разработки текущей архитектуры нет
Основываясь на перечисленных допущениях, подход к разработке архитектуры выбран исходя из принципа необходимой достаточности - т.е. минимального бюджета на разработку и инфраструктуру, и, следовательно, набора компонентов в минимальном объеме, позволяющим обеспечить требуемый функционал.
### Диаграмма контекста (C1):

![C1](static/c1.svg)

Предполагается, что любой из существующих компонентов может отправить оповещение пользователю. При этом существующие каналы связи и предпочтения по их использованию известны системе оповещений, компоненты остальной системы знать это не должны.

### Диаграмма контейнеров (C2):

![alt text](static/c2.svg)
Система нотификации состоит из следующих компонентов:
* Notification Queue
	* Очередь для уведомлений
* Settings Queue
	* Очередь для настроек уведомлений
* Notification Service
	* Работа с уведомлениями
		* Осуществляет прием сообщений от клиентской системы
		* Читает из БД настройки для данного клиента или группы клиентов
		* Отправляет сформированные сообщения в очередь сообщений в соответствии с настройками
	* Работа с настройками
		* Осуществляет прием настроек от клиентской системы
		* Выполняет запись настроек в БД и в кэше настроек
* Settings DB
	* Хранение настроек уведомлений, получаемых от клиентских систем
* Email / SMS / Push Queue
	* Очереди сформированных сообщений для каждого канала уведомлений
* Email / SMS / Push Gateway
	* Осуществляют чтение из соответствующей очереди сформированных сообщений
	* Выполняет отправку уведомления через соответствующий внешний сервер рассылки
	* В случае неуспешной попытки отправки повторно записывает сообщение в очередь не более заданного числа раз. Информация об оставшимся числе попыток передается через заголовок сообщения. При исчерпании попыток записывает сообщение в очередь DLQ.
* Dead Letter Queue (DLQ)
	* Хранит неотправленные уведомления, для которых исчерпаны попытки повторной отправки
	* Данные в очереди могут использоваться для анализа инцидентов или обработаны в ручном режиме инструментами администрирования брокера сообщений

### ADL

|Id|Дата|Статус|Участники|Решения|
|:-:|:-:|:-:|---|---|
|[ADR-1](adr_01.md)|10.10.2023|Принято|Парфенова Елена|Асинхронное взаимодействие между компонентами системы на базе Kafka|
|[ADR-2](adr_02.md)|10.10.2023|Принято|Парфенова Елена|Использовать для кэширования настроек кэш БД|
|[ADR-3](adr_03.md)|10.10.2023|Принято|Парфенова Елена|Разделение обработки для разных каналов по отдельным топикам и обработчикам|
### Диаграмма компонентов (C3):
![alt text](static/c3-1.svg)

![alt text](static/c3-2.svg)
Компоненты SMS Gateway и Push Gateway имеют аналогичную архитектуру с Email Gateway.
### Обеспечение атрибутов качества и перспективы развития системы:
* Надежность
	* Надежность хранения
		* База данных
			* Настройки уведомлений и неотправленные сообщения хранятся в персистируемом хранилище - базе данных
			* Обеспечивается репликация master-slave 
			* Бэкап данных осуществляется на регулярной основе
		* Брокер сообщений
			* Сообщения хранятся в персистируемой очереди
			* Неотправленные сообщения либо отправляются на повторную обработку, либо складываются в отдельную очередь для последующего анализа
	* Надежность доставки
		* Брокер сообщений
			* Надежность доставки обеспечивается с помощью брокера сообщений
			* Брокер сообщений может быть развернут в кластере
			* Обеспечивается репликация топиков
		* Механизм повторной отправки сообщений
			* При необходимости вместо DQL можно добавить отдельную систему обработки неотправленных сообщений с отдельным компонентом повторной отправки и хранением сообщений в базе данных для расширения возможностей анализа и ручной обработки
* Масштабирование, доступность, производительность
	* Программа-минимум: 
		* Сервисы Notification Service и Email / SMS/ Push Gateway разворачиваются в двух экземплярах для обеспечения доступности
		* Поскольку база данных настроек является read-heavy, на данном этапе для обеспечения производительности будет использоваться кэш базы данных
	* Варианты развития:
		* Сервисы Notification Service и Email / SMS/ Push Gateway разворачиваются в нескольких экземплярах для обеспечения производительности и доступности
		* Каждый из сервисов Email / SMS/ Push Gateway можно масштабировать в соответствии с нагрузкой канала
		* При необходимости можно добавить автомасштабирование, если это позволяют инструменты инфраструктуры
		* Кэш базы данных с ростом нагрузки может стать узким местом, в этом случае можно будет добавить отдельно стоящий кэш
* Безопасность
	* Программа-минимум: 
		* Подсистема нотификаций должна быть расположена в милитаризованной зоне
	* Варианты развития:
		* При необходимости запросы между сервисами могут быть аутентифицированы посредством передачи токена, подписанного ЭЦП
		* При необходимости запросы между сервисами могут быть авторизованы
		* При необходимости можно вынести систему в отдельный контур, добавить балансировщик, REST API, API Gateway, который может выполнять функции аутентификации, Rate Limiter, SSL Termination
* Расширяемость
	* Компоненты Email / SMS/ Push Gateway можно организовать в виде единого контейнера подключаемых плагинов для разных каналов связи
* Observability
	* Программа-минимум:
		* Нативная система логирования (на диске)
		* Инструменты мониторинга
		* Трассировки
	* В зависимости от необходимости и бюджета проекта могут использоваться инструменты
		* Централизованного хранения логов