# Технический проект "Сервис отправки оповещений"

> Это фрагмент Технического проекта, который нужно заполнить в рамках практического задания темы "Технический проект".
---

## Текущая архитектура

В текущей архитектуре у нас есть мобильное приложение, которое общается с компонентом "Controller", а он в свою очередь делает запросы к "Foo" и "Bar".

![alt text](static/current_arch.svg)


## Целевая архитектура

В процессе работы с ТЗ были выделены следующие функциональные требования к системе:

1. Возможность для произвольного сервиса (с достаточными правами доступа) рассылать оповещения клиентам. На момент написания это сервисы: Controller, Component Foo, Component Bar. Положим, что этот список может вырасти.
	1. Рассылки могут быть как массовыми (группе клиентов), так и точечными (конкретным клиентам).
	2. Оповещения отправляются по трём каналам связи: Email, Push, SMS.
2. Хранение предпочтений клиентов о том, по каким каналам связи они хотят получать уведомления, а также адреса, на которые должны приходить их уведомления (почта, логин, номер телефона).

Поскольку подразумевается получение входных данных сразу от нескольких компонентов, было принято решение создать REST API (ADR-002) с единой точкой входа: Nginx API Gateway (ADR-001). API подразумевает два основных контроллера. Условно назовем их API Пользовательских настроек и API Уведомлений.
- API Пользовательских настроек принимает информацию от клиентов по их предпочтениям и сохраняет их в БД (ADR-003) для дальнейшего использования. 
- API Уведомлений получает параметры рассылки, с идентификаторами пользователей и/или обозначением нужного канала связи и контентом оповещения.

Уведомления далее проходят предобработку с учетом специфики выбранных каналов связи и их ограничений (e.g. ограничение на число символов в SMS), затем попадают в брокер сообщений (ADR-004).

Процесс отправки разделен на три очереди в соответствии с требуемыми каналами связи (ADR-006). Сообщения из каждой очереди отходят во внешние сервисы рассылок со скоростью, равной их (сервисов) пропускной способности.

В процессе работы каждого контейнера системы мы собираем метрики и логи, что позволит нам выявить потенциальные проблемы с сервисом на раннем этапе (ADR-007).

При внедрении прототипа мы будем опираться на следующие ключевые моменты:
1. **Функциональность**. Система должна отвечать всем функциональным требованиям. Необходима процедура интеграционного тестирования. 
2. **Удобство в использовании**. Насколько API понятно для разработчиков систем-потребителей, сколько времени требуется на интеграцию существующих систем с ним.
3. **Производительность**. Общая пропускная способность системы, снять метрики времени, которое проходит от попадания уведомления в систему до доставки его клиенту.
4. **Надежность**. Провести нагрузочное тестирования чтобы выявить предельную нагрузку системы с текущей архитектурой и её соответствие ожидаемой нагрузке.
5. **Стоимость**. Оценить время и ресурсы, потраченные на разработку прототипа, и дать оценку по времени и ресурсам, необходимым на доведение его до состояния готового продукта.

Помимо этого, нужно оценить необходимость хранения уведомлений, попавших в очередь с целью восстановления данных в случае форс-мажора на нашей стороне (ADR-008). Для экономии времени на разработку, рекомендуется не включать это в прототип. Аналогично мы можем поступить для уведомлений, которые не получилось доставить (ADR-010).

### ADL

|ID|Дата|Статус|Имя|Решение|
|---|---|---|---|---|
|[ADR-001](adr/adr_1.md)|08.10.23|Принято|Стайнов Л.А.|Использовать Nginx API Gateway в качестве reverse-proxy|
|[ADR-002](adr/adr_2.md)|08.10.23|Принято|Стайнов Л.А.|Использовать REST API для коммуникации с внешними сервисами и шлюзами доставки уведомлений|
|[ADR-003](adr/adr_3.md)|08.10.23|Принято|Стайнов Л.А.|Использовать MongoDB для хранения пользовательских предпочтений|
|[ADR-4](adr/adr_4.md)|08.10.23|Принято|Стайнов Л.А.|Использовать брокер сообщений RabbitMQ для маршрутизации пользовательских уведомлений|
|[ADR-5](adr/adr_5.md)|08.10.23|Принято|Стайнов Л.А.|Использовать Go как основной стек разработки API|
|[ADR-6](adr/adr_6.md)|08.10.23|Принято|Стайнов Л.А.|Использовать отдельные очереди для разных типов уведомлений (SMS/Push/Email)|
|[ADR-7](adr/adr_7.md)|08.10.23|Принято|Стайнов Л.А.|Внедрить логирование во все компоненты системы на стеке ELK|
|[ADR-8](adr/adr_8.md)|08.10.23|Предложено|Стайнов Л.А.|(ОПЦИОНАЛЬНО) Осуществлять хранение неотправленных уведомлений на случай падения системы или недоступности сети|
|[ADR-9](adr/adr_9.md)|13.10.23|Принято|Стайнов Л.А.|Использовать Nginx в качестве балансировщика|
|[ADR-10](adr/adr_10.md)|13.10.23|Предложено|Стайнов Л.А.|Предусмотреть хранилище для уведомлений, упавших на отправке, чтобы вернуть их в очередь для повторной попытки|

### Диаграмма контекста (C1):
![C1](static/c1.svg)

Предполагается, что любой из существующих компонентов может отправить оповещение пользователю. При этом существующие каналы связи и предпочтения по их использованию известны системе оповещений, компоненты остальной системы знать это не должны.

### Диаграмма контекста (C2):
![[с2.drawio.svg]]

### Диаграмма контекста (C3):
![[с3.drawio.svg]]