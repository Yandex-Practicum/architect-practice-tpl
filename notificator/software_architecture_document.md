# Технический проект "Сервис отправки оповещений"

> Это фрагмент Технического проекта, который нужно заполнить в рамках практического задания темы "Технический проект".
---

## Текущая архитектура

В текущей архитектуре у нас есть мобильное приложение, которое общается с компонентом "Controller", а он в свою очередь делает запросы к "Foo" и "Bar".

![Схема текущей архитектуры](static/current_arch.svg)


## Целевая архитектура

### Диаграмма контекста (C1):
![Диаграмма C1](static/c1.svg)

Предполагается, что любой из существующих компонентов может отправить оповещение пользователю. При этом существующие каналы связи и предпочтения по их использованию известны системе оповещений, компоненты остальной системы знать это не должны.

Ожидаемая нагрузка (на основании анализа потребностей и диалога с заказчиком) составляет не более 10^2 запросов
в секунду, размер каждого сообщения 1Кб (округлен до ближайшего целого), количество пользователей с предпочитаемыми настройками
до 1000, требуемая надежность беспрерывной работы 99,99%.

### Диаграмма контейнеров (C2):
![Диаграмма C2](static/c2.svg)

Для реализации проекта предлагается использовать распределенную архитектуру, работающую по REST API [ADR-001](adr/adr-001.md)
для возможности масштабирования узких мест, т.к. при значительном количестве
запросов есть риск того, что система не сможет справляться с поступающими уведомлениями. Так-же различная скорость обработки, зависящая от типа уведомления,
требует разделения способов обработки для уменьшения влияния друг на друга и возможности масштабирования различных каналов в зависимости от загрузки.
Применяемые технологии python, RabbitMQ, postgreSQl, Nginx, все инструменты сочетаются друг с другом, распространены и используются в уже ранее реализованных
компонентах.

С учетом этого предлагаются следующие основные контейнеры:
- API Gateway - единая точка входа [ADR-002](adr/adr-002.md)
- Services - основной сервис, в котором происходит основная логика обработки сообщений (прием, шаблонизация, повторы)
- Queue - брокер сообщений [ADR-003](adr/adr-003.md)
- User Preferences DB - база данных для хранения пользовательских предпочтений [ADR-004](adr/adr-004.md)
- Email\SMS\PUSH handler - однотипные обработчики уведомлений для взаимодействия с внешними сервисами отправки учитывающих
особенности различных типов уведомлений

В текущей реализации не рассматриваются вопросы сбора аналитических данных (метрики, логирование, трассировка) т.к. не входят в исходные требования.
Требуется принятие дополнительного решения о необходимости реализации дополнительного компонента (или уточнение дальнейших действий)
для проблемных уведомлений [ADR-009](adr/adr-008.md), т.к. это может повлияить на дальнейшую архитектуру (хранилище для сообщений, каналы для уведомления
заинтересованных пользовтелей и т.д.)

#### ADL для диаграммы контейнеров:
| ID                        | Дата       | Статус     | Участники         | Решения                                                                                     | 
|---------------------------|------------|------------|-------------------|---------------------------------------------------------------------------------------------|
| [ADR-001](adr/adr-001.md) | 07.10.2023 | Принято    | Заказчик          | Использовать REST API для взаимодействия с сервисом отправки уведомлений и шлюзами отправки |
| [ADR-002](adr/adr-002.md) | 07.10.2023 | Принято    | Жмурко Константин | Использовать API Gateway для взаимодействия с пользователями                                |
| [ADR-003](adr/adr-003.md) | 07.10.2023 | Принято    | Жмурко Константин | Использовать брокер для доставки уведомлений обработчикам                                   |
| [ADR-004](adr/adr-004.md) | 07.10.2023 | Принято    | Жмурко Константин | Использовать реляционное хранилище для хранения настроек пользователей                      |
| [ADR-005](adr/adr-005.md) | 07.10.2023 | Заменено   | Жмурко Константин | Добавить компонент для повторной отправки неудачный уведомлений                             |
| [ADR-008](adr/adr-007.md) | 07.10.2023 | Принято | Жмурко Константин | Добавить компонент для обработки ограничений связанных с типом сообщения | 
| [ADR-009](adr/adr-009.md) | 07.10.2023 | Предложено | Жмурко Константин | Добавить компонент для обработки сообщений не доставленных после исчерпания повторных попыток |
| [ADR-010](adr/adr-010.md) | 10.10.2023 | Предложено | Жмурко Константин | Добавить компонент для повторной отправки неудачный уведомлений                             |

### Диаграммы компонетнов (C3)

#### Компонент Notification handler:
![Диаграмма C3 компонента Service:](static/c3_1.svg)

Основные компоненты системы:
- User Preferences API - модуль для получения пользовательских предпочтений по отправке различных типов уведомлений, работает
с использованием REST API
- Send API - модуль для приема сообщений с использованием REST API от существующих компонентов и доставки их для дальнейшей обработки
- Notification service - основной модуль для обработки поступающих уведомлений, проверки имеемых ограничений\настроек
подготовки их к отправке (шаблонизации) и доставки в очередь в соответствии с типом уведомления
- Limiter/Validator - модуль содержащий логику, на основании которой сервис принимает решение о разрешении или
запрете отправки различных уведомлений (повторы, частота, объем и пр.) [ADR-008](adr/adr-007.md)
- Retry service [ADR-010](adr/adr-010.md) - модуль получающий не отправленные сендерами сообщения из очереди Dead letter и принимающий решение о
  (на основании установленных лимитов и требований) о дальнейших действиях (удаление, уведомление и т.д.)
- Очереди для различных типов уведомлений [ADR-006](adr/adr-005.md)

Пользователи взаимодействуют с сервисом через единую точку входа выполняющую роль балансировщика и прокси к 
нужному модулю. Для получения настроек предпочтений пользователей используется отдельный модуль взаимодейтсвущий 
с базой данных. Поступающие уведомления через модуль приема сообщений поступают в Notification service, где 
происходит проверка необходимости отправки конкретного уведомления пользователю (в соответствии с настройками),
проверка лимитов на возможность отправки, шаблонизация и отправка сообщения в соответствующую очередь. Проблемные
сообщения получаются из очереди dead letter модулем Retry service, который принимает решение о дальнейших действиях.


#### ADL для компонента Notification handler:
| ID                        | Дата       | Статус  | Участники         | Решения                                                                             | 
|---------------------------|------------|---------|-------------------|-------------------------------------------------------------------------------------|
| [ADR-006](adr/adr-005.md) | 07.10.2023 | Принято | Жмурко Константин | Использовать отдельные очереди для каналов связи                                    |
| [ADR-007](adr/adr-006.md) | 07.10.2023 | Принято | Жмурко Константин | Использовать отдельный слой для доступа к хранилищу данных настроек и пользователей |

#### Компоненты Email\SMS\PUSH handler:
![Диаграмма C3 компонентов Email\SMS\PUSH handler](static/c3_2.svg)

Отправки уведомлений осуществляется однотипными компонентами, которые можно независимо расширять\масштабировать.
Каждый компонент подписывается на свою очередь читает поступающие сообщения, с учетом установленных лимитов на 
отправку, и пытается отправить внешнему сервису. При неудачной отправке sender, используя паттерн [retry](https://www.abhinavpandey.dev/blog/retry-pattern), после исчерпания
установленных попыток уведомление отправляется в очередь dead letter для дальнейшей обработки

Критерии оценки прототипа:
- Соответствие требованиям: прототип должен реализовывать:
  - отправку оповещения по трем каналам email, sms, push
  - принимать от пользователя настройки по каждому каналу (вкл./выкл., адрес/номер/логин) и учитывать их при отправке
  - отправку одного сообщения по всем каналам группе клиентов
  - ограничения разных каналов связи
- Удовлетворение пользовательских потребностей: 
  - способность имеемых компонентов взаимодействовать с сервисом
  - возможность отправки уведомлений по имеемым каналам связи
- Легкость использования: 
  - достаточность API для отправки уведомлений
- Производительность:
  - возможность взаимодействия с системами от которых поступают уведомления без влияния на их работу
  - возможную скорость поступления и обработки уведомлений для каждого канала
  - время затрачиваемое для обработки уведомления без влияния сторонних факторов
- Надежность: 
  - сохранность сообщений при сбоях отправки
  - сохранность сообщений при сбоях в работе сервиса
  - способность справляться с нагрузкой без потери сообщений
- Эффективность и производительность: 
  - достаточность решения с очередями для реализации отправки и повторения неудачных сообщений
  - необходимость кеширования
- Обратная связь и участие пользователей: 
  - тестирование пользователями работоспособности
- Соответствие бюджету и срокам: 
  - возможность реализации сервиса в установленные сроки
- Возможности для улучшения:
  - возможные доработки по результатам тестирования