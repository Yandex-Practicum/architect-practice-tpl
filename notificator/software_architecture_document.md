# Технический проект "Сервис отправки оповещений"

> Это фрагмент Технического проекта, который нужно заполнить в рамках практического задания темы "Технический проект".
---

## Текущая архитектура

В текущей архитектуре у нас есть мобильное приложение, которое общается с компонентом "Controller", а он в свою очередь делает запросы к "Foo" и "Bar".

![alt text](static/current_arch.svg)


## Целевая архитектура

### Диаграмма контекста (C1):
![C1](static/c1.svg)

Предполагается, что любой из существующих компонентов может отправить оповещение пользователю. При этом существующие каналы связи и предпочтения по их использованию известны системе оповещений, компоненты остальной системы знать это не должны.

### Диаграмма контекста (C2):
![C2](static/с2.svg)

Система уведомлений, к которой, по идее, может подключиться неограниченное количество участников,
априори может быстро превратиться в высоконагруженное приложение.

В таком случае у нас появится необходимость в масштабировании отдельных(узких) мест или всего приложения.
В связи с этим был выбран путь микросервисной(МКС) архитектуры(https://learn.microsoft.com/en-us/dotnet/architecture/microservices/architect-microservice-container-applications/microservices-architecture)
Используя МКС мы получаем много преимуществ, подробней([ADR-001](static/adr/adr-001.md))

Приложение будет разбито на несколько сервисов

  - Основной сервис(Controller). Здесь происходит вся основная логика обработки сообщений(идентификация, шаблонизация, удаление дублей).
   

  - Сервис пользовательской конфигурации(Configuration service). Было принято решение вынести сервис конфигураций настроек пользователей отдельно, благодаря этому
      мы сможем масштабировать его отдельно от других компонентов системы.


  - Слой предварительной обработки сообщений(Middleware System). Перед попаданием сообщений в нашу первичную очередь, необходимо валидировать данные(схему)
      за это будет отвечать небольшой сервис реализованный на любом языке, в подробности не вдавался, так как тут можно сделать что угодно, но так как все остальное у нас на java,
      думаю этот сервис так же нужно будет реализовать на java. 


  - База данных(База данных).В качестве БД выбрана PostgresQL, реляционная база данных нам нужна для необходимых выборок из данных по условиям, что отлично ложится на таблицы,
      не знаю на сколько будет качественное шардирование базы, потому что оно увеличит сложность поддержки системы многократно,
      предлагаю пока обойтись дополнительными репликами для чтения, а если уже и запись возрастет, тогда и подумать над шардированием.


  - Брокер сообщений(Message broker). Наша система планирует быть высоконагруженной и нам важна сохранность сообщений,
        масштабируемость и при необходимости распределенность системы сообщений, плюс брокер должен уметь делать не только push,
        но и работать с pull запросами по паттерну Polling Consumer(https://www.enterpriseintegrationpatterns.com/patterns/messaging/PollingConsumer.html),
        выбор был сделан в сторону ActiveMQ, подробней([ADR-002](static/adr/adr-002.md))


  - Система аутентификации, авторизации(Authentication System). Все запросы ко всем компонентам должны быть защищены. 
        Чтобы не создавать свой сервис для авторизации, есть возможность использовать готовое решение Keycloak,
        инструмент с открытым кодом, многим знаком и многие его используют, подробней([ADR-002](static/adr/adr-003.md))

----

### Диаграмма контекста (C3):
![C3](static/с3.svg)

Внешние системы должны регистрировать себя в приложении уведомлений, так же после регистрации добавлять своих пользователей в систему для 
будущей выборки по отправке сообщений(Чтобы другие пользователи не получали лишних уведомлений)
Внешней системе так же доступна настройка(включение/отключение) видов уведомлений которые она предоставляет(Смс, email, push) их количество(Если есть ограничение по кол-ву).

После регистрации, внешняя система может получить необходимые схемы в формате JSON, для разных уведомлений.

Добавлен API администратора, сервису нужен контроль со стороны. Для загрузки и редактирования шаблонов сообщений(JSON Schema) и управление приложением.
В частности частота отправки различных уведомлений, максимальное количество уведомлений.

Все сообщения обрабатываются в зависимости от правил шаблонов(Смс, email, push).

Предусмотренно два обменника, один для необработанных сообщений(сторонние системы),
второй для форматированных сообщений по шаблонам, подготовленных к отправке в сервисы уведомлений.

---- 

***Что стоит проверить или обсудить(с другими архитекторами, командой)***

   - Дополнительную авторизацию перед подключением к очереди, 
     мы можем поставить прокси или шлюз для взаимодействия с Keycloak для аутентификации и авторизации
     или через сам nginx передавать в header все необходимое, перед перенаправлением запросов к RabbitMQ


   - Ограничения push уведомлений. Есть варианты подключения нескольких разных серверов отправки уведомлений,
     чтобы обойти ограничение(если такое имеется) на количество отправок.
     Так же мы можем отправлять сообщения пачками, например Firebase Cloud Messaging (FCM) позволяет отправлять пуш-уведомления в пачках с помощью API,
     но тогда уведомления могут приходить с задержкой, пока не наберется достаточное кол-во для отправки.
     Мы можем взять максимальное кол-во запросов к серверу, после аналитики нагрузок найти максимально загруженные дни, часы
     и в эти моменты собирать сообщения в пачки(допустим поставить два лимита, 100 сообщений и 2 секунды, по истечению любого из условий, отправку), алгоритм разработать при необходимости(сейчас его описывать не буду)
     
----

***Прототип***

Мы можем создать монолит.

 1. Отказываемся от брокера и делаем очередь в самом сервисе Controller на java.
 2. Для авторизации в прототипе можем использовать простой секьюрити из spring-boot в памяти
 3. Не берем в работу сервисы отправки уведомлений по разным провайдерам, валидацию схем при поступлении в очередь,
    брокера сообщений, внешний сервис с keycloak.

Функционал, который будет реализован:
 
- Регистрация внешней системы в нашем сервисе
- Получение схемы для отправки уведомлений(на момент прототипа возьмем за данность, что схема везде одинаковая)
- Отправка сообщения в систему внешней системой
- Регистрация пользователя, получателя сообщения из внешней системы(в прототипе пользователь зарегистрируется сам, а не внешняя система)
- Пользователь может настроить уведомления(глобально, без выбора систем)

Так же прототип зависит от сроков. 