# Технический проект "Сервис отправки оповещений"

> Это фрагмент Технического проекта, который нужно заполнить в рамках практического задания темы "Технический проект".
---

## Текущая архитектура

В текущей архитектуре у нас есть мобильное приложение, которое общается с компонентом "Controller", а он в свою очередь делает запросы к "Foo" и "Bar".

![alt text](static/current_arch.svg)


## Целевая архитектура

### Предполагаемая нагрузка:

В задании не указана ожидаемая нагрузка, поэтому напишу фанфик.

Нам известно, что пользователями сервиса будут другие подсистемы. Допустим, изначально такая подсистема будет всего одна, но с достаточно большим числом пользователей -- 100к месячных пользователей. Сервис шлет оповещения каждому из них по 10 раз в день в рабочие часы, особенно активно используя пуши и имейл. 100к умножаем на 10 и делим на число секунд в рабочих часах, 1млн / (8 * 60 * 60) -- получается около 34 rps и например 50 rps в пике.
Через полгода собираются заехать еще два сервиса со сходным числом пользователей. Постараемся подготовиться к нагрузкам втрое больше ~150 rps.

Для пользователей мы должны хранить настройки оповещений и контактные данные. Настройки оповещений скорее всего будут меняться не очень часто, а вот читать эти настройки нужно будет при каждом запросе на отправку оповещения, значит, система будет Read intensive. 
### Диаграмма контекста (C1):
![C1](static/c1.svg)

Предполагается, что любой из существующих компонентов может отправить оповещение пользователю. При этом существующие каналы связи и предпочтения по их использованию известны системе оповещений, компоненты остальной системы знать это не должны.

### Диаграмма контекста (C2):

![C2](static/c2.svg)

Система будет состоять из следующих модулей:

* API Gateway -- входная точка для клиентов системы. Осуществляет аутентификацию и роутинг запросов. Для этого используем Nginx.
	https://nginx.org/en/docs/http/ngx_http_auth_request_module.html#auth_request
	https://nginx.org/en/docs/http/ngx_http_proxy_module.html

* Load Balancer -- Nginx https://nginx.org/en/docs/http/load_balancing.html

- Golang сервер управления отправкой сообщений, который умеет
    - получать сообщения от других систем через системный интерфейс
    - позволяет отправлять сообщение по всем каналам группе клиентов
    - позволяет отправлять сообщение адресно в каждый канал связи конкретным адресатам
    - добавляет сообщения в очередь на отправку согласно настройкам каналов
    - менять настройки отправления сообщений в реальном времени
	Документация по использованию network API в go https://pkg.go.dev/net@go1.21.3
    
- Хранилище -- база данных PostgreSQL, которая хранит информацию об учетных записях пользователей из других подсистем и настроек сообщений для них

- Очередь сообщений RabbitMQ для отправки в разных каналах. Позволяет обрабатывать сообщения в порядке очереди и учитывать пропускные лимиты каналов. 
	https://learn.microsoft.com/en-us/azure/architecture/patterns/queue-based-load-leveling
	https://www.rabbitmq.com/queues.html

- Компоненты для предобработки и отправки сообщений:
    - SMS:
        предусматривает ограничение количества символов в СМС
    - Email:
        предусматривает возможность попадания email в спам
    - Push:
        предусматривает возможность отправки пушей на разные платформы (iOS, Android, Web)
	Вряд ли есть потребность целиком реализовывать эти сервисы, можно взять внешние решения и добавить адаптеры для них.

### Architecture Decision List:
|ID|Дата|Статус|Имя|Решение|
|---|---|---|---|---|
|[ADR-1](static/adr/adr-1.md)|08.10.23|Принято|Полина Шестакова|Модульная архитектура|
|[ADR-2](static/adr/adr-2.md)|08.10.23|Принято|Полина Шестакова|Сервер для управления отправкой сообщений|
|[ADR-3](static/adr/adr-3.md)|08.10.23|Принято|Полина Шестакова|База данных для хранения настроек отправки|
|[ADR-4](static/adr/adr-4.md)|08.10.23|Принято|Полина Шестакова|Брокер сообщений|
|[ADR-5](static/adr/adr-5.md)|08.10.23|Принято|Полина Шестакова|API Gateway и Load Balancer|
|[ADR-6](static/adr/adr-6.md)|08.10.23|Принято|Полина Шестакова|Логирование и мониторинг|

### Диаграмма компонентов (C3):

![C3](static/c3.svg)
### Критерии оценки прототипа:

1. Оповещения доходят до адресатов по всем поддержанным каналам
2. Настройки оповещений позволяют ограничивать отправку
3. Микросервисная архитектура позволяет легко отключать и включать каждый из каналов
4. Система выдерживает ожидаемую нагрузку, включая пиковую