# Технический проект "Сервис отправки оповещений"

> Это фрагмент Технического проекта, который нужно заполнить в рамках практического задания темы "Технический проект".
---

## Текущая архитектура

В текущей архитектуре у нас есть мобильное приложение, которое общается с компонентом "Controller", а он в свою очередь делает запросы к "Foo" и "Bar".

![alt text](static/current_arch.svg)

## Целевая архитектура

Сервис будет построен на микросервисной архитектуре ([ADR-013](ADR/ADR-013.md)) в качестве фреймворка для разработки используется AspNet Core ([ADR-014](ADR/ADR-014.md)).

Входящий запрос из внешней подсистемы попадает в Gateway API ([ADR-001](ADR/ADR-001.md)), где происходит аутентификация клиента, балансировка нагрузки и маршрутизация запроса в API ([ADR-002](ADR/ADR-002.md)).

Далее запрос попадает в компонент API, где происходит валидация данных, регистрация запроса на отправку уведомления (создается запись о поступившем запросе в БД), проверяется возможность отправки уведомления (есть ли в настройках пользователя нужный тип уведомления) и затем происходит формирование и отправка сообщения (в сообщении должны содержаться текст уведомления и данные получателя ([ADR-007](ADR/ADR-007.md))) в брокер очередей ([ADR-003](ADR/ADR-003.md)). Каждый тип уведомления (Email, SMS, Push) отправляется в отдельную очередь ([ADR-008](ADR/ADR-008.md)).

Сообщения из очереди попадают в компонент consumer (для каждого типа уведомлений отдельное приложение ([ADR-004](ADR/ADR-004.md))). Тут происходит попытка отправить уведомление через внешний сервис (реквизиты внешних сервисов хранятся в настройках приложения ([ADR-009](ADR/ADR-009.md))). В случае возникновения ошибок происходит попытка повторной отправки уведомления (при помощи переотправки сообщения в очередь ([ADR-010](ADR/ADR-010.md))). Запросы на отправку СМС дополнительно проходят этап биллинга ([ADR-011](ADR/ADR-011.md)) и могут быть отправлены через альтернативные шлюзы ([ADR-012](ADR/ADR-012.md))

Происходящие на любом этапе обработки запроса ошибки логируются в системе хранения логов ([ADR-006](ADR/ADR-006.md))

Система состоит из следующих компонентов:
* Gateway API - сервис на базе AspNet Core и [Ocelot](https://github.com/ThreeMammals/Ocelot), является точкой входа в сервис, обеспечивает маршрутизацию запросов, аутентификацию клиентов и балансировку нагрузки
* API - HTTP REST API сервис на базе AspNet Core приложения. Осуществляет валидацию и обработку запросов от внешних подсистем. Формирует и отправляет в очередь сообщения для последующей отправки уведомлений. Обрабатывает следующие запросы:
  * Получение настроек пользователя
  * Редактирование настроек пользователя
  * Отправка уведомлений (осуществляется по асинхронной схеме)
  * Получение статуса уведомления
  * Мультиплексированная отправка уведомлений
* Брокер сообщений ([RabbitMQ](https://github.com/rabbitmq)) - обеспечивает транспортировку сообщений с данными уведомлений к компонентам систему, отвечающих за их отправуку. 
* Consumer-ы очередей - приложения на базе AspNet Code. Получают из очередей сообщения с данными уведомлений и выполняют их отправку
  * Email Consumer - осуществляет оправку эл. почты
  * SMS Consumer - осуществляет отправку СМС сообщений
  * Push Consumer - осуществляет отправку push-уведомлений
* БД ([PostgreSQL](https://www.postgresql.org/docs/)) - используется для хранения данных по настройкам пользователей, статусам уведомлений, биллингу СМС сообщений
* Логи ([Loki + Grafana](https://grafana.com/oss/loki/)) - используется для хранения логов об ошибках 

### ADL
| ID | Дата | Статус | Участники | Решение | 
| :-: | :-: | :-: | :-: | :-: |
| [ADR-001](ADR/ADR-001.md) | 14.10.2023 | Принято | Махнев Антон | Использовать Gateway API |
| [ADR-002](ADR/ADR-002.md) | 09.10.2023 | Принято | Махнев Антон | Использовать HTTP REST API |
| [ADR-003](ADR/ADR-003.md) | 09.10.2023 | Принято | Махнев Антон | Использовать брокер очередей (RabbitMQ) |
| [ADR-004](ADR/ADR-004.md) | 12.10.2023 | Принято | Махнев Антон | Компонент для обработки сообщений из очередей |
| [ADR-005](ADR/ADR-005.md) | 13.10.2023 | Принято | Махнев Антон | Использовать БД (PostgrSQL) |
| [ADR-006](ADR/ADR-006.md) | 14.10.2023 | Принято | Махнев Антон | Логировать ошибки (Loki + Grafana) |
| [ADR-007](ADR/ADR-007.md) | 15.10.2023 | Принято | Махнев Антон | Не сохранять в БД текст уведомления |
| [ADR-008](ADR/ADR-008.md) | 15.10.2023 | Принято | Махнев Антон | Каждый тип уведомлений отправлять в отдельную очередь |
| [ADR-009](ADR/ADR-009.md) | 15.10.2023 | Принято | Махнев Антон | Использовать настройки приложения |
| [ADR-010](ADR/ADR-010.md) | 15.10.2023 | Принято | Махнев Антон | Выполнять повторную отправку при ошибках |
| [ADR-011](ADR/ADR-011.md) | 15.10.2023 | Принято | Махнев Антон | Биллинг для SMS |
| [ADR-012](ADR/ADR-012.md) | 15.10.2023 | Принято | Махнев Антон | Альтернативные шлюзы для SMS |
| [ADR-013](ADR/ADR-013.md) | 15.10.2023 | Принято | Махнев Антон | Использовать микросервисную архитектуру |
| [ADR-014](ADR/ADR-014.md) | 15.10.2023 | Принято | Махнев Антон | Использовать AspNet Core |

### Диаграмма контекста (C1):
![C1](static/c1.svg)

Предполагается, что любой из существующих компонентов может отправить оповещение пользователю. При этом существующие каналы связи и предпочтения по их использованию известны системе оповещений, компоненты остальной системы знать это не должны.

### Диаграмма контейнеров (C2):
![C2](static/C2.svg)

### Диаграмма компонентов (C3):
#### API
![C3 API](static/C3_API.svg)

#### Email Consumer
![C3 Consumers Email](static/C3_Consumers_Email.svg)

#### SMS Consumer
![C3 Consumers SMS](static/C3_Consumers_Sms.svg)

#### Push Consumer
![C3 Consumers Push](static/C3_Consumers_Push.svg)

### Критерии оценки прототипа
* Сервис удобен в использовании для внешних подсистем
* Сервис позволяет получать и управлять настройками пользователей
* Сервис позволяет отправлять уведомления, уведомления доходят до получателей
* Учитываются особенности и ограничения каналов связи
* Есть возможность настраивать каналы связи