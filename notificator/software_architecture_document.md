# Технический проект "Сервис отправки оповещений"
---

## Текущая архитектура

В текущей архитектуре у нас есть мобильное приложение, которое общается с компонентом "Controller", а он в свою очередь делает запросы к "Foo" и "Bar".

![alt text](static/current_arch.svg)


## Целевая архитектура

### Уровень контекста контекста (C1):
![C1](static/c1.svg)

Предполагается, что любой из существующих компонентов может отправить оповещение пользователю. При этом существующие каналы связи и предпочтения по их использованию известны системе оповещений, компоненты остальной системы знать это не должны.

### Уровень модулей (C2):

![C2](static/c2.svg)

Описанная подсистема - это набор следующих модулей:
* **API Отправки уведомлений.** Основной модуль, который отвечает за обработку запросов на отправку уведомлений.
Обращение к базе данных для получения настроек отправки, шаблонов уведомлений. Распределение уведомлений в брокере сообщений.
Также отвечает за обработку неотправленных уведомлений.[adr_1.md](static%2Fadr%2Fadr_1.md)
* **Брокер сообщений**. Хранение уведомлений, распределенных по очередям в зависимости от типа.[adr_3.md](static%2Fadr%2Fadr_3.md)
* **Провайдеры сообщений**. Модули, которые интегрируются с внешними системами рассылки уведомлений и взаимодействующие 
с очередями для каждого типа уведомлений.[adr_5.md](static%2Fadr%2Fadr_5.md)
* **База данных.** Данный модуль необходим для хранения настроек отправки уведомлений, шаблонов для уведомлений и неотправленных уведомлений.[adr_2.md](static%2Fadr%2Fadr_2.md)
* **Балансировщик нагрузки.** Для распределения нагрузки между модулями при горизонтальном масштабировании. [adr_4.md](static%2Fadr%2Fadr_4.md)

### Уровень компонентов (C3)

[//]: # (![C43]&#40;static/с3.svg&#41;)

На уровне C3 модули верхнего уровня декомпозируются и представляются как связанные компоненты:
1) **Контроллер настроек отправки.** Данный компонент отвечает за управление настройками и шаблонами, которые используются
в системе. 
2) **Контроллер уведомлений.** Через данный компонент осуществляется передача задания на отправку уведомлений.
3) **Шаблонизатор уведомлений**. Обработка уведомлений используя сохраненные шаблоны. Данный процесс производится
в зависимости от настроек для каждого задания на отправку уведомлений.
4) **Сервис настроек для уведомлений.** Предназначен для взаимодействия с базой данных для изменения или получения настроек и шаблонов.
5) **Сервис формирования уведомлений**. Отвечает за обработку поступивших заданий на отправку уведомлений,
используя шаблоны и настройки через сервисы "Сервис настроек и уведомлений" и "Шаблонизатор уведомлений". 
Обработанные уведомления размещает в очереди в зависимости от типа уведомлений.
6) **Сервис обработки неотправленных сообщений**. В случае если сообщение было не отправлено, оно сохраняется в базе и 
в зависимости от настроек отправки(количество повторных попыток отправки при ошибке в сети) 
передается в сервис формирования уведомлений или помечается в базе статусом неотправленного
для дальнейшего предоставления внешней системе(Клиент) по запросу.
7) **Очереди сообщений**. Для каждого типа уведомлений предусмотрена отдельная очередь(email, push, sms).
Также добавлена очередь для неотправленных сообщений, содержащая уведомления, которые были возвращены
с ошибкой из внешних систем по рассылке.
8) **Провайдер отправки сообщения**. Данный компонент реализует получение уведомлений из очереди сообщений и направляет
запрос во внешнюю систему рассылки уведомлений. В случае ошибки при отправке уведомления, оно помещается в очередь
неотправленных уведомлений. При увеличении объема уведомлений, для любой из очередей можно увеличить количество провайдеров,
которые будут обрабатывать сообщения перед отправкой во внешние сервисы рассылки.
